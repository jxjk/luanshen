# 工艺数字孪生系统 - 阶段一实施计划

## 一、现状分析

### 1.1 已实现功能
- ✅ 参数优化微服务（基于微生物遗传算法）
- ✅ 基础数据管理（材料、刀具、设备、策略）
- ✅ 前端界面（React + TypeScript + Bootstrap）
- ✅ RESTful API（FastAPI）
- ✅ 数据库集成（MySQL + SQLAlchemy）
- ✅ Docker 容器化部署

### 1.2 待实现功能（阶段一核心需求）
根据《需求规格说明书》，阶段一需要补充以下核心功能：

#### 缺失功能清单

| 功能模块 | 优先级 | 状态 | 说明 |
|---------|--------|------|------|
| 设备监控微服务 | 高 | ❌ 未实现 | 实时采集设备状态、坐标、报警、负载数据 |
| 报警管理微服务 | 高 | ❌ 未实现 | 多级报警规则、自动推送、闭环管理 |
| 质量追溯微服务 | 高 | ❌ 未实现 | 全过程追溯、时间轴回放、关联分析 |
| 实时监控前端 | 高 | ❌ 未实现 | 车间级视图、设备级视图、3D虚拟机床 |
| 时序数据库 | 中 | ❌ 未实现 | 支持高频数据存储（≥1kHz） |
| NC代码解析 | 中 | ❌ 未实现 | G代码解析、碰撞检测、切削仿真 |
| 工艺知识库 | 中 | ❌ 未实现 | 案例库、智能检索、专家经验沉淀 |
| 报告自动生成 | 中 | ❌ 未实现 | 生产报告、质量报告、设备效能报告 |
| RBAC权限管理 | 中 | ❌ 未实现 | 基于角色的访问控制 |
| 数据采集协议 | 中 | ❌ 未实现 | OPC UA、MTConnect、Modbus |

## 二、实施计划

### 2.1 技术架构设计

#### 微服务架构
```
工艺数字孪生系统
├── api-gateway              # API网关（鉴权、路由、限流）
├── services/
│   ├── parameter-optimization  # 参数优化服务（已实现）
│   ├── device-monitor          # 设备监控服务（新增）
│   ├── alarm-management        # 报警管理服务（新增）
│   ├── quality-trace           # 质量追溯服务（新增）
│   ├── nc-simulation           # NC代码仿真服务（新增）
│   ├── knowledge-base          # 工艺知识库服务（新增）
│   └── report-generation       # 报告生成服务（新增）
├── infrastructure/
│   ├── influxdb              # 时序数据库（新增）
│   ├── redis                 # 缓存与会话（新增）
│   ├── rabbitmq              # 消息队列（新增）
│   └── mysql                 # 关系型数据库（已存在）
├── frontend/
│   ├── optimization          # 参数优化页面（已实现）
│   ├── monitoring            # 实时监控页面（新增）
│   ├── alarm                 # 报警管理页面（新增）
│   ├── trace                 # 质量追溯页面（新增）
│   └── report                # 报告查看页面（新增）
└── shared/
    ├── common                # 公共代码库
    └── protobuf              # Protobuf定义（可选）
```

#### 技术栈选型

| 组件 | 技术选型 | 说明 |
|------|---------|------|
| API网关 | Kong / Nginx | 统一入口、鉴权、限流 |
| 时序数据库 | InfluxDB 2.x | 高频数据存储、高效查询 |
| 消息队列 | RabbitMQ / Redis | 异步通信、事件驱动 |
| 缓存 | Redis | 会话管理、实时数据缓存 |
| 数据采集 | python-opcua | OPC UA协议支持 |
| WebSocket | FastAPI WebSockets | 实时数据推送 |
| 3D可视化 | Three.js | 虚拟机床3D展示 |
| 图表库 | ECharts / Chart.js | 实时曲线图展示 |

### 2.2 数据库设计

#### MySQL 数据库扩展
在现有 `ga_tools` 数据库基础上，新增以下表：

```sql
-- 设备监控相关表
CREATE TABLE device_status (
    id INT PRIMARY KEY AUTO_INCREMENT,
    device_id INT NOT NULL,
    status ENUM('RUNNING', 'IDLE', 'ALARM', 'MAINTENANCE') NOT NULL,
    current_x DECIMAL(10,3),
    current_y DECIMAL(10,3),
    current_z DECIMAL(10,3),
    spindle_speed DECIMAL(10,2),
    feed_rate DECIMAL(10,2),
    load_percent DECIMAL(5,2),
    alarm_code VARCHAR(50),
    alarm_message VARCHAR(255),
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_time (device_id, recorded_at),
    FOREIGN KEY (device_id) REFERENCES machines(id)
);

-- 报警记录表
CREATE TABLE alarm_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    device_id INT NOT NULL,
    alarm_level ENUM('WARNING', 'ALARM', 'CRITICAL') NOT NULL,
    alarm_code VARCHAR(50) NOT NULL,
    alarm_message VARCHAR(255),
    status ENUM('OPEN', 'ACKNOWLEDGED', 'RESOLVED', 'CLOSED') DEFAULT 'OPEN',
    acknowledged_by VARCHAR(50),
    acknowledged_at TIMESTAMP NULL,
    resolved_by VARCHAR(50),
    resolved_at TIMESTAMP NULL,
    resolution_note TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_status (device_id, status),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (device_id) REFERENCES machines(id)
);

-- 质量追溯记录表
CREATE TABLE quality_trace_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    workpiece_id VARCHAR(100) NOT NULL UNIQUE,
    workpiece_name VARCHAR(255),
    production_order_id VARCHAR(50),
    material_id VARCHAR(50),
    tool_id INT,
    machine_id INT,
    strategy_id INT,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    total_duration INT COMMENT '总耗时（秒）',
    nc_program_path VARCHAR(500),
    operator VARCHAR(50),
    quality_grade ENUM('EXCELLENT', 'GOOD', 'ACCEPTABLE', 'REJECTED'),
    inspection_result TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_workpiece (workpiece_id),
    INDEX idx_order (production_order_id),
    FOREIGN KEY (tool_id) REFERENCES tools(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (strategy_id) REFERENCES strategies(id)
);

-- 质量追溯参数明细表
CREATE TABLE quality_trace_parameters (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    trace_record_id INT NOT NULL,
    parameter_name VARCHAR(50) NOT NULL,
    parameter_value DECIMAL(15,4),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_trace_time (trace_record_id, timestamp),
    FOREIGN KEY (trace_record_id) REFERENCES quality_trace_records(id)
);

-- 工艺知识库案例表
CREATE TABLE process_cases (
    id INT PRIMARY KEY AUTO_INCREMENT,
    case_name VARCHAR(255) NOT NULL,
    material_id VARCHAR(50),
    tool_id INT,
    machine_id INT,
    strategy_id INT,
    parameters JSON COMMENT '优化参数JSON',
    quality_result JSON COMMENT '质量结果JSON',
    success_rate DECIMAL(5,2),
    notes TEXT,
    tags JSON,
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_material (material_id),
    INDEX idx_tags ((CAST(tags AS CHAR(255)))),
    FOREIGN KEY (tool_id) REFERENCES tools(id),
    FOREIGN KEY (machine_id) REFERENCES machines(id),
    FOREIGN KEY (strategy_id) REFERENCES strategies(id)
);

-- 用户表（RBAC）
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    email VARCHAR(100),
    role ENUM('ADMIN', 'ENGINEER', 'OPERATOR', 'VIEWER') NOT NULL,
    department VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    last_login TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 报告模板表
CREATE TABLE report_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_name VARCHAR(255) NOT NULL,
    template_type ENUM('PRODUCTION', 'QUALITY', 'EQUIPMENT', 'OPTIMIZATION') NOT NULL,
    template_config JSON NOT NULL COMMENT '报告配置JSON',
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 报告生成记录表
CREATE TABLE report_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_id INT NOT NULL,
    report_name VARCHAR(255) NOT NULL,
    report_type ENUM('PRODUCTION', 'QUALITY', 'EQUIPMENT', 'OPTIMIZATION') NOT NULL,
    report_file_path VARCHAR(500),
    generation_params JSON,
    generated_by VARCHAR(50),
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (template_id) REFERENCES report_templates(id)
);
```

#### InfluxDB 数据库设计
用于存储高频传感器数据：

```sql
-- Measurement: device_sensor_data
-- Tags: device_id, sensor_type
-- Fields: value, unit
-- Timestamp: timestamp

-- Measurement: process_parameters
-- Tags: device_id, parameter_type
-- Fields: speed, feed, cut_depth, cut_width, power, torque, vibration, temperature
-- Timestamp: timestamp
```

### 2.3 实施步骤

#### 第一步：基础设施搭建（Week 1-2）
- [ ] 部署 InfluxDB 时序数据库
- [ ] 部署 Redis 缓存
- [ ] 部署 RabbitMQ 消息队列
- [ ] 更新 Docker Compose 配置
- [ ] 创建 API 网关（Kong）
- [ ] 扩展 MySQL 数据库表结构

#### 第二步：设备监控微服务（Week 3-4）
- [ ] 创建 `services/device-monitor` 微服务
- [ ] 实现 OPC UA 数据采集模块
- [ ] 实现设备状态管理
- [ ] 实现实时数据存储到 InfluxDB
- [ ] 实现 WebSocket 实时推送
- [ ] 编写 API 文档和测试

#### 第三步：报警管理微服务（Week 5-6）
- [ ] 创建 `services/alarm-management` 微服务
- [ ] 实现报警规则引擎
- [ ] 实现报警推送（短信、邮件、WebSocket）
- [ ] 实现报警闭环管理
- [ ] 集成 RabbitMQ 消息队列
- [ ] 编写 API 文档和测试

#### 第四步：质量追溯微服务（Week 7-8）
- [ ] 创建 `services/quality-trace` 微服务
- [ ] 实现追溯记录管理
- [ ] 实现时间轴数据存储
- [ ] 实现关联分析功能
- [ ] 实现二维码/RFID 集成
- [ ] 编写 API 文档和测试

#### 第五步：实时监控前端（Week 9-10）
- [ ] 创建车间级视图页面
- [ ] 创建设备级视图页面
- [ ] 集成 ECharts 实时曲线图
- [ ] 集成 Three.js 3D虚拟机床
- [ ] 实现报警通知组件
- [ ] 前端测试和优化

#### 第六步：RBAC权限管理（Week 11）
- [ ] 实现用户认证（JWT）
- [ ] 实现基于角色的访问控制
- [ ] 实现操作审计日志
- [ ] 前端登录页面
- [ ] API 网关集成鉴权

#### 第七步：NC代码解析与仿真（Week 12-13）
- [ ] 创建 `services/nc-simulation` 微服务
- [ ] 实现 G代码解析器
- [ ] 实现碰撞检测算法
- [ ] 实现切削仿真（可选）
- [ ] 实现加工时间估算
- [ ] 编写 API 文档和测试

#### 第八步：工艺知识库（Week 14）
- [ ] 创建 `services/knowledge-base` 微服务
- [ ] 实现案例管理（CRUD）
- [ ] 实现智能检索（相似度计算）
- [ ] 实现专家经验数字化
- [ ] 编写 API 文档和测试

#### 第九步：报告生成模块（Week 15）
- [ ] 创建 `services/report-generation` 微服务
- [ ] 实现报告模板管理
- [ ] 实现报告生成引擎
- [ ] 支持多种格式（PDF、Excel）
- [ ] 定时任务调度
- [ ] 编写 API 文档和测试

#### 第十步：集成测试与优化（Week 16）
- [ ] 端到端集成测试
- [ ] 性能测试和优化
- [ ] 安全测试
- [ ] 文档完善
- [ ] 部署优化

## 三、关键技术实现

### 3.1 设备监控微服务

#### 核心功能
1. **OPC UA 数据采集**
```python
# services/device-monitor/src/collectors/opcua_collector.py
from asyncua import Client

class OPCUACollector:
    async def connect(self, url: str):
        """连接 OPC UA 服务器"""
        
    async def collect_data(self, node_ids: List[str]):
        """采集节点数据"""
        
    async def subscribe(self, node_ids: List[str], callback):
        """订阅节点变化"""
```

2. **实时数据存储**
```python
# services/device-monitor/src/stores/timeseries_store.py
from influxdb_client import InfluxDBClient

class TimeSeriesStore:
    def write_point(self, measurement: str, tags: dict, fields: dict, timestamp: datetime):
        """写入数据点"""
        
    def query_data(self, measurement: str, time_range: tuple, filters: dict):
        """查询数据"""
```

3. **WebSocket 实时推送**
```python
# services/device-monitor/src/websocket_manager.py
from fastapi import WebSocket

class WebSocketManager:
    async def broadcast(self, device_id: str, data: dict):
        """广播设备数据到所有连接的客户端"""
```

### 3.2 报警管理微服务

#### 核心功能
1. **报警规则引擎**
```python
# services/alarm-management/src/rule_engine.py
class AlarmRule:
    condition: str  # 条件表达式
    level: str      # 报警级别
    message: str    # 报警消息
    
    def evaluate(self, context: dict) -> bool:
        """评估规则是否触发"""
```

2. **报警推送**
```python
# services/alarm-management/src/notifiers/email_notifier.py
# services/alarm-management/src/notifiers/sms_notifier.py
# services/alarm-management/src/notifiers/websocket_notifier.py

class NotificationService:
    async def send_notification(self, alarm: Alarm, channels: List[str]):
        """发送报警通知"""
```

### 3.3 质量追溯微服务

#### 核心功能
1. **追溯记录管理**
```python
# services/quality-trace/src/services/trace_service.py
class TraceService:
    def create_trace_record(self, workpiece_id: str, metadata: dict):
        """创建追溯记录"""
        
    def append_parameter(self, trace_id: int, parameters: dict):
        """追加参数数据"""
        
    def get_timeline(self, workpiece_id: str):
        """获取时间轴数据"""
```

### 3.4 RBAC权限管理

#### JWT 认证
```python
# shared/common/auth/jwt_handler.py
import jwt
from datetime import datetime, timedelta

class JWTHandler:
    def create_token(self, user_id: int, role: str) -> str:
        """创建 JWT Token"""
        
    def verify_token(self, token: str) -> dict:
        """验证 JWT Token"""
```

#### 装饰器鉴权
```python
# shared/common/auth/permissions.py
from functools import wraps

def require_role(*roles: str):
    """角色权限装饰器"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # 验证用户角色
            return await func(*args, **kwargs)
        return wrapper
    return decorator
```

## 四、API 设计规范

### 4.1 RESTful API 设计原则
- 使用资源导向的 URL
- 使用 HTTP 方法（GET、POST、PUT、DELETE）
- 统一的响应格式
- 版本控制（/api/v1/）

### 4.2 统一响应格式
```json
{
  "success": true,
  "message": "操作成功",
  "data": { },
  "timestamp": "2026-02-02T10:30:00Z"
}
```

### 4.3 错误响应格式
```json
{
  "success": false,
  "message": "错误描述",
  "error_code": "ERROR_CODE",
  "details": { },
  "timestamp": "2026-02-02T10:30:00Z"
}
```

## 五、非功能性需求

### 5.1 性能要求
- 数据采集延迟：≤1秒
- 监控画面刷新：≤3秒
- 系统并发：支持≥100台设备同时在线
- WebSocket 连接：支持≥1000个并发连接

### 5.2 可靠性
- 系统可用性：≥99.5%
- 数据备份：每日增量备份，每周全量备份
- 故障恢复：关键服务故障≤10分钟恢复

### 5.3 安全性
- HTTPS/TLS 传输加密
- JWT Token 认证
- RBAC 权限控制
- 操作审计日志
- SQL 注入防护（ORM 参数化查询）
- XSS/CSRF 防护

## 六、验收标准

### 6.1 功能验收
- [ ] 设备监控微服务正常运行，能够采集和推送实时数据
- [ ] 报警管理微服务能够正确触发和推送报警
- [ ] 质量追溯微服务能够记录和查询追溯数据
- [ ] 前端监控页面能够实时展示设备状态和曲线
- [ ] RBAC 权限管理正常工作
- [ ] 所有 API 文档完整且可用

### 6.2 性能验收
- [ ] 数据采集延迟 ≤1秒
- [ ] 监控画面刷新 ≤3秒
- [ ] 支持≥100台设备同时在线
- [ ] 支持≥1000个WebSocket并发连接

### 6.3 质量验收
- [ ] 单元测试覆盖率 ≥70%
- [ ] 集成测试全部通过
- [ ] 无严重安全漏洞
- [ ] 代码审查全部通过

## 七、风险与应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| 数据采集设备不支持 OPC UA | 中 | 高 | 开发 Modbus/MTConnect 适配器 |
| 实时数据处理性能不足 | 中 | 高 | 使用消息队列异步处理、数据库优化 |
| 前端3D展示性能问题 | 低 | 中 | 使用 WebGL 优化、降级方案 |
| 集成第三方系统困难 | 高 | 高 | 标准化 API、提供适配器模式 |
| 开发进度延迟 | 中 | 中 | 敏捷开发、优先级排序、MVP 优先 |

## 八、项目里程碑

| 里程碑 | 时间 | 交付物 |
|--------|------|--------|
| M1: 基础设施搭建完成 | Week 2 | Docker Compose 配置、数据库初始化 |
| M2: 设备监控微服务上线 | Week 4 | 设备监控服务、API 文档 |
| M3: 报警管理微服务上线 | Week 6 | 报警管理服务、消息队列集成 |
| M4: 质量追溯微服务上线 | Week 8 | 质量追溯服务、时间轴功能 |
| M5: 实时监控前端上线 | Week 10 | 车间视图、设备视图页面 |
| M6: RBAC 权限管理上线 | Week 11 | 用户认证、权限控制 |
| M7: NC代码仿真微服务上线 | Week 13 | NC 解析、碰撞检测 |
| M8: 工艺知识库上线 | Week 14 | 知识库服务、智能检索 |
| M9: 报告生成模块上线 | Week 15 | 报告生成服务、模板管理 |
| M10: 阶段一验收交付 | Week 16 | 完整系统、文档、培训材料 |

## 九、资源需求

### 9.1 人力资源
- 后端开发工程师：2-3人
- 前端开发工程师：1-2人
- 测试工程师：1人
- DevOps 工程师：1人
- 项目经理：1人

### 9.2 硬件资源
- 开发服务器：4核8G × 2台
- 测试服务器：4核8G × 2台
- 生产服务器：8核16G × 4台（推荐）
- 数据库服务器：8核32G × 2台（MySQL + InfluxDB）

### 9.3 软件资源
- 开发工具：VS Code、PyCharm、Git
- 测试工具：Postman、JMeter、Selenium
- 监控工具：Grafana、Prometheus
- 容器化：Docker、Docker Compose

## 十、下一步行动

1. **立即开始**：搭建基础设施（InfluxDB、Redis、RabbitMQ）
2. **本周完成**：扩展 MySQL 数据库表结构
3. **下周启动**：设备监控微服务开发
4. **持续跟进**：每周例会、代码审查、进度跟踪

---

**文档版本**：v1.0  
**创建日期**：2026-02-02  
**最后更新**：2026-02-02  
**维护者**：工艺数字孪生项目团队